<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rebel Datapad Codex</title>
<style>
/* Base layout + aesthetic */
* { box-sizing:border-box; margin:0; padding:0; font-family:'OCR A Std','Courier New', monospace; }
body {
  min-height: 100vh;
  background: radial-gradient(ellipse at center, #1E3A8A 0%, #050505 100%);
  color: #a0d8ff;
  padding: 20px;
  justify-content: center;
  align-items: center;
  cursor: none;
  overflow-y: auto;
}

/* Datapad centered on screen */
#datapad {
  width:900px; height:600px;
  background: url('images/metal_texture.jpg') center/cover no-repeat;
  border:6px solid #333;
  border-radius:25px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 60px rgba(0,255,255,0.05), inset 0 0 20px #000;
  overflow:hidden;
}
#datapad::before {
  content:"";
  position:absolute; inset:0;
  border-radius:25px;
  background: url('images/metal_noise.png') repeat;
  opacity:0.2;
  z-index:0;
}

/* Screen inside datapad */
#screen {
  position:absolute;
  top:40px; left:40px;
  width:820px; height:520px;
  border-radius:15px;
  overflow:hidden;
  box-shadow: inset 0 0 20px rgba(0,255,255,0.2);
  z-index:1;
  animation: glowPulse 3s infinite alternate;
  cursor:none;
}
#screen * { cursor:none; }

/* Add a solid black background so the metal doesn't show through */
#screen::before {
  content: "";
  position: absolute;
  inset: 0;
  background: #000;
  z-index: 0;
}

/* Scrollable inner content with persistent blue overlay */
#screen-inner {
  position: relative;
  height: 100%;
  overflow-y: auto;
  background: radial-gradient(circle at 50% 50%, rgba(10,20,25,0.95) 0%, rgba(5,10,12,0.9) 100%);
  z-index: 2;
}

/* Blue overlay effects (stays during scroll) */
#blueBase {
  position: fixed;
  top: 40px;
  left: 40px;
  width: 820px;
  height: 520px;
  background-color: rgba(0,255,255,0.35);
  pointer-events:none;
  z-index: 1;
  mix-blend-mode: screen;
}
#blueBase::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: repeating-linear-gradient(0deg, rgba(0,255,255,0.05) 0px, rgba(0,255,255,0.05) 1px, transparent 2px, transparent 3px);
  opacity: 0.3;
  animation: staticNoise 0.2s steps(2) infinite;
  z-index:2;
}

/* Flicker & scanline */
#flicker {
  position:absolute; inset:0;
  background: repeating-linear-gradient(0deg, rgba(0,255,255,0.15) 0px, rgba(0,255,255,0.15) 1px, transparent 2px, transparent 3px);
  pointer-events:none;
  z-index:6;
  opacity:0;
}
#screen::after {
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background: repeating-linear-gradient(to bottom, rgba(0,255,255,0.03) 0px, rgba(0,255,255,0.03) 1px, transparent 2px, transparent 3px);
  animation: scanlines 1s linear infinite;
  z-index:7;
}
@keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 4px; } }

#distortion {
  position:absolute;
  inset:0;
  background: radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(0,255,255,0.18) 0%, transparent 40%);
  pointer-events:none;
  z-index:5;
}

/* Glow pulse animation */
@keyframes glowPulse {
  0% { box-shadow: inset 0 0 20px rgba(0,255,255,0.15); }
  50% { box-shadow: inset 0 0 35px rgba(0,255,255,0.3); }
  100% { box-shadow: inset 0 0 25px rgba(0,255,255,0.2); }
}
@keyframes staticNoise { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

/* Layout: sidebar & main content */
#content { display:flex; height:100%; position:relative; z-index:0; }

#sidebar {
  width:200px;
  background:rgba(5,15,20,0.8);
  border-right:1px solid #033;
  display:flex;
  flex-direction:column;
  padding:15px;
  gap:6px;
  z-index:2;
}
#sidebar h2 {
  color:#33cfff;
  text-align:center;
  margin-bottom:6px;
}

/* GM section label */
.gm-section-label {
  margin-top:10px;
  margin-bottom:2px;
  font-size:11px;
  letter-spacing:0.1em;
  text-transform:uppercase;
  color:#66f0ff;
  opacity:0.7;
}

.category-btn {
  background:#0a1f26;
  border:none;
  padding:8px;
  color:#33cfff;
  cursor:pointer;
  text-align:left;
  border-left:4px solid #0a5266;
  transition: all 0.14s;
}
.category-btn:hover { background:#0e2a34; border-left-color:#66f0ff; }
.category-btn.active { border-left-color:#00ffff; background:#0e2a34; }

#search {
  margin-top:auto;
  padding:6px;
  background:#0b1c23;
  border:1px solid #33cfff;
  color:#a0d8ff;
}

#main { flex:1; padding:20px; overflow-y:auto; position:relative; z-index:0; }
#breadcrumbs {
  margin-bottom:10px;
  font-size:14px;
  color:#33cfff;
  display:flex;
  gap:6px;
  align-items:center;
}
#breadcrumbs span { cursor: pointer; }
#entryContent h1 {
  font-size:22px;
  margin-bottom:10px;
  color:#66f0ff;
  position:relative;
  z-index:0;
}
#entryContent img {
  display:block;
  margin:10px auto;
  max-width:100%;
  max-height:300px;
  border:2px solid #33cfff;
  border-radius:4px;
  box-shadow:0 0 15px rgba(0,255,255,0.3);
  position:relative;
  z-index:0;
}
#entryContent p {
  font-size:15px;
  line-height:1.5em;
  position:relative;
  z-index:0;
  white-space:pre-wrap;
}

/* Entry list button coloring indicators */
.entry-row {
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0;
}
.entry-title {
  flex:1;
  background:#0a1f26;
  border:none;
  padding:8px;
  color:#a0d8ff;
  text-align:left;
  cursor:pointer;
  border-left:6px solid #0a5266;
  border-radius:4px;
}
.entry-title.locked   { border-left-color:#777;   color:#777; }
.entry-title.gm-locked{ border-left-color:#ffcc33; color:#ffffcc; }
.entry-title.unlocked { border-left-color:#0f0;  color:#bfffdc; }

.unlock-btn {
  padding:6px 8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#003;
  color:#66ffff;
}
.unlock-btn.remove { background:#700; color:#ffc; }

#gmIndicator {
  position:absolute;
  top:10px;
  left:12px;
  background: rgba(0,0,0,0.45);
  color:#66ffff;
  font-size:12px;
  font-weight:700;
  padding:4px 8px;
  border-radius:6px;
  z-index:8;
  pointer-events:none;
  opacity:0;
  transition: opacity 0.16s ease;
}
#gmIndicator.active { opacity:1; }

/* cursor dot and indicators */
.indicator {
  position:absolute;
  width:12px;
  height:12px;
  border-radius:50%;
  background:#0f0;
  box-shadow:0 0 8px #0f0;
}
.indicator.red { background:#f00; box-shadow:0 0 8px #f00; }
.indicator:nth-child(1){ top:10px; left:10px; }
.indicator:nth-child(2){ top:10px; right:10px; }
.indicator:nth-child(3){ bottom:10px; left:10px; }
.indicator:nth-child(4){ bottom:10px; right:10px; }

#cursor-dot {
  position:absolute;
  width:12px;
  height:12px;
  border-radius:50%;
  background: rgba(0,255,255,0.8);
  box-shadow:0 0 8px rgba(0,255,255,0.8), 0 0 15px rgba(0,255,255,0.5);
  pointer-events:none;
  transform: translate(-50%, -50%);
  z-index:3;
}
#dotFlicker {
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:4;
}
.dot {
  position:absolute;
  width:2px;
  height:2px;
  border-radius:50%;
  background: rgba(0,255,255,0.6);
  box-shadow:0 0 4px rgba(0,255,255,0.8);
  pointer-events:none;
}

/* Destiny Pool panel */
.destiny-grid {
  display:flex;
  gap:20px;
  margin-bottom:16px;
  flex-wrap:wrap;
}
.destiny-column {
  flex:1 1 200px;
  padding:10px;
  background:rgba(5,15,22,0.85);
  border:1px solid #064a5b;
  border-radius:8px;
  box-shadow:0 0 12px rgba(0,255,255,0.12);
}
.destiny-column h2 {
  font-size:16px;
  margin-bottom:8px;
  color:#66f0ff;
}
.destiny-token-row {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  min-height:26px;
  margin-bottom:8px;
}
.destiny-token {
  width:18px; height:18px;
  border-radius:50%;
  border:1px solid #00ffff;
  box-shadow:0 0 8px rgba(0,255,255,0.7);
}
.destiny-token.light {
  background:radial-gradient(circle at 30% 30%, #ffffff 0%, #c9f9ff 40%, #0f3844 100%);
}
.destiny-token.dark {
  background:radial-gradient(circle at 30% 30%, #111827 0%, #020617 50%, #000000 100%);
  box-shadow:0 0 8px rgba(0,0,0,0.8);
  border-color:#8899aa;
}

.destiny-controls {
  display:flex;
  gap:6px;
}
.destiny-controls button,
.destiny-actions button {
  background:#0a1f26;
  border:1px solid #33cfff;
  color:#a0d8ff;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
  border-radius:4px;
}
.destiny-controls button:hover,
.destiny-actions button:hover {
  background:#0e2a34;
}

.destiny-actions {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:12px;
}

.destiny-log {
  padding:10px;
  background:rgba(5,15,22,0.85);
  border:1px solid #064a5b;
  border-radius:8px;
  max-height:180px;
  overflow-y:auto;
}
.destiny-log h3 {
  font-size:14px;
  margin-bottom:6px;
  color:#66f0ff;
}
.destiny-log-entry {
  font-size:12px;
  margin-bottom:4px;
  color:#a0d8ff;
  opacity:0.9;
}

/* small responsive tweak */
@media (max-width:960px){
  #datapad{ transform: scale(0.92); }
}
</style>
</head>
<body>
<div id="datapad">
  <div class="indicator"></div>
  <div class="indicator red"></div>
  <div class="indicator red"></div>
  <div class="indicator"></div>

  <div id="screen">
    <div id="flicker"></div>
    <div id="distortion"></div>

    <div id="content">
      <div id="sidebar">
        <h2>Codex</h2>
        <button id="homeBtn" class="category-btn">Home</button>
        <button class="category-btn" data-category="planets">Planets</button>
        <button class="category-btn" data-category="characters">Characters</button>
        <button class="category-btn" data-category="technology">Technology</button>
        <button class="category-btn" data-category="items">Items</button>
        <button class="category-btn" data-category="factions">Factions</button>
        <button class="category-btn" data-category="missions">Missions</button>

        <div class="gm-section-label">GM Tools</div>
        <button class="category-btn gm-tool-btn" id="gmDestinyBtn">Destiny Pool</button>

        <input type="text" id="search" placeholder="Search...">
      </div>

      <div id="main">
        <div id="breadcrumbs"></div>
        <div id="entryContent">
          <h1>Rebel Alliance Field Codex</h1>
          <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>
        </div>
        <div id="blueBase"></div>
      </div>
    </div>

    <div id="dotFlicker"></div>
    <div id="cursor-dot"></div>
    <div id="gmIndicator">GM</div>
  </div>
</div>

<script>
/* Full functionality:
   - Codex categories mapped to entries/<category>/manifest.json
   - GM Mode toggled with G (hidden), unlocks persist via localStorage
   - Destiny Pool GM Tool stored in localStorage (sw_destiny_pool, sw_destiny_log)
*/

document.addEventListener('DOMContentLoaded', () => {
  const categories = ['planets','characters','technology','items','factions','missions'];
  const entryContent = document.getElementById('entryContent');
  const breadcrumbs = document.getElementById('breadcrumbs');
  const categoryBtns = document.querySelectorAll('.category-btn');
  const gmDestinyBtn = document.getElementById('gmDestinyBtn');
  const searchInput = document.getElementById('search');
  const homeBtn = document.getElementById('homeBtn');
  const flicker = document.getElementById('flicker');
  const distortion = document.getElementById('distortion');
  const screen = document.getElementById('screen');
  const cursorDot = document.getElementById('cursor-dot');
  const dotFlicker = document.getElementById('dotFlicker');
  const gmIndicator = document.getElementById('gmIndicator');

  let activeCategory = null;
  let activeEntry = null;
  let activeTool = null; // e.g. "destiny"
  let isGM = false;

  // cache loaded entries per category to avoid refetching unless user wants to refresh
  const cache = {};

  // Destiny pool storage keys
  const DESTINY_STATE_KEY = 'sw_destiny_pool';
  const DESTINY_LOG_KEY   = 'sw_destiny_log';

  let destinyState = loadDestinyState();
  let destinyLog = loadDestinyLog();

  // helper localStorage key for codex unlocks
  const lsKey = id => `entry_unlocked__${id}`;

  // utility: safe fetch JSON or null
  async function fetchJson(path) {
    try {
      const r = await fetch(path, { cache: "no-cache" });
      if (!r.ok) return null;
      return await r.json();
    } catch (e) {
      console.error('fetch error', path, e);
      return null;
    }
  }

  // load manifest (simple array) and then each entry JSON
  async function loadCategoryEntries(category) {
    // return cached if present
    if (cache[category]) return cache[category];

    const manifestPath = `entries/${category}/manifest.json`;
    const files = await fetchJson(manifestPath);
    if (!Array.isArray(files)) {
      console.warn('manifest missing or invalid for', category, manifestPath);
      cache[category] = [];
      return [];
    }

    const entries = [];
    for (const file of files) {
      const filePath = `entries/${category}/${file}`;
      const data = await fetchJson(filePath);
      if (!data) {
        console.warn('failed to load entry', filePath);
        continue;
      }
      // ensure id exists (use filename if not)
      if (!data.id) {
        data.id = file.replace(/\.[^/.]+$/, "");
      }
      data.category = category;
      entries.push(data);
    }
    cache[category] = entries;
    return entries;
  }

  /* ----------------- BREADCRUMBS ----------------- */

  function updateBreadcrumbs() {
    breadcrumbs.innerHTML = '';
    if (activeTool === 'destiny') {
      const gmSpan = document.createElement('span');
      gmSpan.textContent = 'GM Tools';
      const sep = document.createElement('span');
      sep.textContent = ' > ';
      const toolSpan = document.createElement('span');
      toolSpan.textContent = 'Destiny Pool';
      breadcrumbs.appendChild(gmSpan);
      breadcrumbs.appendChild(sep);
      breadcrumbs.appendChild(toolSpan);
      return;
    }

    if (!activeCategory) return;
    const catSpan = document.createElement('span');
    catSpan.textContent = activeCategory.charAt(0).toUpperCase() + activeCategory.slice(1);
    catSpan.addEventListener('click', ()=> { activeEntry = null; renderListForActiveCategory(); });
    breadcrumbs.appendChild(catSpan);
    if (activeEntry) {
      const sep = document.createElement('span'); sep.textContent = ' > ';
      const entrySpan = document.createElement('span'); entrySpan.textContent = activeEntry.name;
      breadcrumbs.appendChild(sep); breadcrumbs.appendChild(entrySpan);
    }
  }

  /* ----------------- CODEX LIST / DETAIL ----------------- */

  async function renderListForActiveCategory() {
    entryContent.innerHTML = '';
    activeTool = null; // ensure we are not in a GM tool when listing codex
    if (!activeCategory) {
      entryContent.innerHTML = `<h1>Rebel Alliance Field Codex</h1>
        <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
      updateBreadcrumbs();
      return;
    }

    const entries = await loadCategoryEntries(activeCategory);
    const q = (searchInput.value || '').trim().toLowerCase();

    // list container
    const list = document.createElement('div');

    for (const entry of entries) {
      const isGMOnly = Boolean(entry.gmMode);
      const unlocked = isGMOnly ? (localStorage.getItem(lsKey(entry.id)) === "true") : true;

      // if not unlocked for player and not in GM Mode, hide
      if (!unlocked && !isGM) continue;

      // apply search filter
      const textMatch =
        entry.name.toLowerCase().includes(q) ||
        (entry.description || '').toLowerCase().includes(q);
      if (q && !textMatch) continue;

      const row = document.createElement('div');
      row.className = 'entry-row';

      const titleBtn = document.createElement('button');
      titleBtn.className = 'entry-title';
      titleBtn.textContent = entry.name;

      if (unlocked) titleBtn.classList.add('unlocked');
      else if (isGM) titleBtn.classList.add('gm-locked');
      else titleBtn.classList.add('locked');

      titleBtn.addEventListener('click', () => {
        activeEntry = entry;
        renderEntryDetail(entry);
      });

      row.appendChild(titleBtn);

      // GM controls for gmMode entries
      if (isGM && isGMOnly) {
        const btn = document.createElement('button');
        const currentlyUnlocked = localStorage.getItem(lsKey(entry.id)) === "true";
        btn.className = 'unlock-btn ' + (currentlyUnlocked ? 'remove' : 'add');
        btn.textContent = currentlyUnlocked ? 'Remove' : 'Add';
        btn.title = currentlyUnlocked ? 'Remove from player view' : 'Add to player view';
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (currentlyUnlocked) {
            localStorage.removeItem(lsKey(entry.id));
          } else {
            localStorage.setItem(lsKey(entry.id), "true");
          }
          renderListForActiveCategory();
        });
        row.appendChild(btn);
      }

      list.appendChild(row);
    }

    if (!list.childElementCount) {
      const msg = document.createElement('p');
      msg.textContent = isGM ? 'No entries match the current filter.' : 'No entries available (locked or none).';
      entryContent.appendChild(msg);
    } else {
      entryContent.appendChild(list);
    }
    updateBreadcrumbs();
  }

  function renderEntryDetail(entry) {
    entryContent.innerHTML = '';
    activeTool = null;

    const title = document.createElement('h1');
    title.textContent = entry.name;
    entryContent.appendChild(title);

    if (entry.image) {
      const img = document.createElement('img');
      img.src = entry.image;
      img.alt = entry.name;
      entryContent.appendChild(img);
    }

    const p = document.createElement('p');
    p.textContent = entry.description || '';
    entryContent.appendChild(p);

    if (isGM && entry.gmMode) {
      const unlocked = localStorage.getItem(lsKey(entry.id)) === "true";
      const gmBtn = document.createElement('button');
      gmBtn.className = 'unlock-btn ' + (unlocked ? 'remove' : 'add');
      gmBtn.textContent = unlocked ? 'Remove' : 'Add';
      gmBtn.style.marginTop = '10px';
      gmBtn.addEventListener('click', () => {
        if (unlocked) localStorage.removeItem(lsKey(entry.id));
        else localStorage.setItem(lsKey(entry.id), "true");
        renderListForActiveCategory();
      });
      entryContent.appendChild(gmBtn);
    }

    const back = document.createElement('button');
    back.className = 'category-btn';
    back.textContent = 'Back';
    back.style.marginTop = '12px';
    back.addEventListener('click', () => { activeEntry = null; renderListForActiveCategory(); });
    entryContent.appendChild(back);

    updateBreadcrumbs();
  }

  /* ----------------- DESTINY POOL STORAGE HELPERS ----------------- */

  function loadDestinyState() {
    try {
      const raw = localStorage.getItem(DESTINY_STATE_KEY);
      if (!raw) return { light: 0, dark: 0 };
      const parsed = JSON.parse(raw);
      return {
        light: Number.isFinite(parsed.light) ? parsed.light : 0,
        dark: Number.isFinite(parsed.dark) ? parsed.dark : 0
      };
    } catch {
      return { light: 0, dark: 0 };
    }
  }

  function loadDestinyLog() {
    try {
      const raw = localStorage.getItem(DESTINY_LOG_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function saveDestinyState() {
    try {
      localStorage.setItem(DESTINY_STATE_KEY, JSON.stringify(destinyState));
    } catch {}
  }

  function saveDestinyLog() {
    try {
      localStorage.setItem(DESTINY_LOG_KEY, JSON.stringify(destinyLog));
    } catch {}
  }

  function addDestinyLogEntry(text) {
    const stamp = new Date();
    const time = stamp.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    destinyLog.unshift(`[${time}] ${text}`);
    if (destinyLog.length > 50) destinyLog.length = 50;
    saveDestinyLog();
  }

  /* ----------------- DESTINY POOL PANEL RENDER ----------------- */

  function renderDestinyPoolPanel() {
    entryContent.innerHTML = '';

    if (!isGM) {
      entryContent.innerHTML = `
        <h1>GM Tools – Destiny Pool</h1>
        <p>GM Tools are restricted. Toggle GM Mode (press <strong>G</strong>) to manage the Destiny Pool.</p>
      `;
      updateBreadcrumbs();
      return;
    }

    activeTool = 'destiny';
    activeCategory = null;
    activeEntry = null;

    entryContent.innerHTML = `
      <h1>GM Destiny Pool</h1>
      <p style="font-size:13px; margin-bottom:10px; opacity:0.85;">
        Track and adjust the session's Light and Dark Side Destiny tokens. Changes are saved on this device.
      </p>

      <div class="destiny-grid">
        <div class="destiny-column">
          <h2>Light Side</h2>
          <div id="destinyLightRow" class="destiny-token-row"></div>
          <div class="destiny-controls">
            <button id="addLight">+ Token</button>
            <button id="removeLight">- Token</button>
          </div>
        </div>
        <div class="destiny-column">
          <h2>Dark Side</h2>
          <div id="destinyDarkRow" class="destiny-token-row"></div>
          <div class="destiny-controls">
            <button id="addDark">+ Token</button>
            <button id="removeDark">- Token</button>
          </div>
        </div>
      </div>

      <div class="destiny-actions">
        <button id="flipLightToDark">Flip Light → Dark</button>
        <button id="flipDarkToLight">Flip Dark → Light</button>
        <button id="resetDestiny">Reset Pool</button>
      </div>

      <div class="destiny-log">
        <h3>Destiny Log</h3>
        <div id="destinyLogEntries"></div>
      </div>
    `;

    const lightRow = document.getElementById('destinyLightRow');
    const darkRow = document.getElementById('destinyDarkRow');
    const logContainer = document.getElementById('destinyLogEntries');

    function drawTokens() {
      lightRow.innerHTML = '';
      darkRow.innerHTML = '';

      for (let i = 0; i < destinyState.light; i++) {
        const t = document.createElement('div');
        t.className = 'destiny-token light';
        lightRow.appendChild(t);
      }
      for (let i = 0; i < destinyState.dark; i++) {
        const t = document.createElement('div');
        t.className = 'destiny-token dark';
        darkRow.appendChild(t);
      }
    }

    function drawLog() {
      logContainer.innerHTML = '';
      if (!destinyLog.length) {
        const empty = document.createElement('div');
        empty.className = 'destiny-log-entry';
        empty.style.opacity = '0.7';
        empty.textContent = 'No changes logged yet.';
        logContainer.appendChild(empty);
        return;
      }
      destinyLog.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'destiny-log-entry';
        div.textContent = entry;
        logContainer.appendChild(div);
      });
    }

    // Button handlers
    document.getElementById('addLight').addEventListener('click', () => {
      destinyState.light++;
      saveDestinyState();
      addDestinyLogEntry('Added one Light Side token.');
      drawTokens(); drawLog();
    });

    document.getElementById('removeLight').addEventListener('click', () => {
      if (destinyState.light > 0) {
        destinyState.light--;
        saveDestinyState();
        addDestinyLogEntry('Removed one Light Side token.');
        drawTokens(); drawLog();
      }
    });

    document.getElementById('addDark').addEventListener('click', () => {
      destinyState.dark++;
      saveDestinyState();
      addDestinyLogEntry('Added one Dark Side token.');
      drawTokens(); drawLog();
    });

    document.getElementById('removeDark').addEventListener('click', () => {
      if (destinyState.dark > 0) {
        destinyState.dark--;
        saveDestinyState();
        addDestinyLogEntry('Removed one Dark Side token.');
        drawTokens(); drawLog();
      }
    });

    document.getElementById('flipLightToDark').addEventListener('click', () => {
      if (destinyState.light > 0) {
        destinyState.light--;
        destinyState.dark++;
        saveDestinyState();
        addDestinyLogEntry('Flipped one Light Side token to Dark.');
        drawTokens(); drawLog();
      }
    });

    document.getElementById('flipDarkToLight').addEventListener('click', () => {
      if (destinyState.dark > 0) {
        destinyState.dark--;
        destinyState.light++;
        saveDestinyState();
        addDestinyLogEntry('Flipped one Dark Side token to Light.');
        drawTokens(); drawLog();
      }
    });

    document.getElementById('resetDestiny').addEventListener('click', () => {
      destinyState = { light: 0, dark: 0 };
      saveDestinyState();
      addDestinyLogEntry('Reset Destiny Pool.');
      drawTokens(); drawLog();
    });

    drawTokens();
    drawLog();
    updateBreadcrumbs();
  }

  /* ----------------- SIDEBAR WIRING ----------------- */

  // Category buttons (Codex)
  categoryBtns.forEach(btn => {
    if (btn.id === 'homeBtn') return;
    if (btn.classList.contains('gm-tool-btn')) return; // GM tools handled separately

    btn.addEventListener('click', async () => {
      const cat = btn.dataset.category;
      if (!categories.includes(cat)) {
        console.warn('unknown category', cat);
        return;
      }
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      activeTool = null;
      activeCategory = cat;
      activeEntry = null;

      await loadCategoryEntries(cat);
      renderListForActiveCategory();
    });
  });

  // GM Destiny Pool button
  gmDestinyBtn.addEventListener('click', () => {
    categoryBtns.forEach(b => b.classList.remove('active'));
    gmDestinyBtn.classList.add('active');

    activeTool = 'destiny';
    activeCategory = null;
    activeEntry = null;

    renderDestinyPoolPanel();
  });

  // Home button
  homeBtn.addEventListener('click', () => {
    categoryBtns.forEach(b => b.classList.remove('active'));
    activeCategory = null;
    activeEntry = null;
    activeTool = null;
    searchInput.value = '';
    entryContent.innerHTML = `<h1>Rebel Alliance Field Codex</h1>
      <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
    breadcrumbs.innerHTML = '';
  });

  // Search handler (filters current category list)
  searchInput.addEventListener('input', () => {
    if (activeCategory) renderListForActiveCategory();
  });

  /* ----------------- GM MODE TOGGLE ----------------- */

  document.addEventListener('keydown', (ev) => {
    if (ev.key.toLowerCase() === 'g') {
      isGM = !isGM;
      gmIndicator.classList.toggle('active', isGM);

      if (activeTool === 'destiny') {
        renderDestinyPoolPanel();
      } else if (activeCategory) {
        renderListForActiveCategory();
      } else {
        renderListForActiveCategory();
      }

      console.log('GM Mode', isGM ? 'ON' : 'OFF');
    }
  });

  /* ----------------- VISUAL FX ----------------- */

  function randomFlicker() {
    if (Math.random() < 0.4) {
      flicker.style.opacity = (0.08 + Math.random() * 0.32).toFixed(2);
      setTimeout(()=> { flicker.style.opacity = 0; }, 50 + Math.random()*180);
    }
  }
  setInterval(randomFlicker, 80);

  function randomDistortion() {
    if (Math.random() < 0.06) {
      const x = (Math.random()*10 - 5).toFixed(1);
      const y = (Math.random()*10 - 5).toFixed(1);
      distortion.style.transform = `translate(${x}px, ${y}px)`;
      setTimeout(()=> distortion.style.transform = 'translate(0,0)', 60 + Math.random()*140);
    }
  }
  setInterval(randomDistortion, 120);

  screen.addEventListener('mousemove', (e) => {
    const r = screen.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    cursorDot.style.left = x + 'px';
    cursorDot.style.top = y + 'px';
  });

  function createRandomDot() {
    const d = document.createElement('div');
    d.className = 'dot';
    d.style.left = Math.random()*100 + '%';
    d.style.top = Math.random()*100 + '%';
    dotFlicker.appendChild(d);
    setTimeout(()=> d.remove(), 120 + Math.random()*220);
  }
  setInterval(()=> { if (Math.random() < 0.28) createRandomDot(); }, 55);

  // initial clean state (no category loaded)
  homeBtn.click();
});
</script>
</body>
</html>
