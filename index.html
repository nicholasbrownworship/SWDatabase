<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rebel Datapad Codex — Test</title>
<style>
/* ====== CORE STYLING ====== */
* { box-sizing:border-box; margin:0; padding:0; font-family:'OCR A Std','Courier New', monospace; }
body {
  background: radial-gradient(ellipse at center, #050505 0%, #000 100%);
  color:#a0d8ff;
  height:100vh; display:flex; justify-content:center; align-items:center;
  overflow:hidden;
}
#datapad {
  width:900px; height:600px;
  background: url('images/metal_texture.jpg') center/cover no-repeat;
  border:6px solid #333;
  border-radius:25px;
  position:relative;
  box-shadow: 0 0 60px rgba(0,255,255,0.05), inset 0 0 20px #000;
  overflow:hidden;
}
#datapad::before {
  content:"";
  position:absolute; inset:0;
  border-radius:25px;
  background: url('images/metal_noise.png') repeat;
  opacity:0.18;
  z-index:0;
}

/* ====== SCREEN & EFFECTS ====== */
#screen {
  position:absolute;
  top:40px; left:40px;
  width:820px; height:520px;
  background:radial-gradient(circle at 50% 50%, rgba(10,20,25,0.96) 0%, rgba(5,10,12,0.92) 100%);
  border-radius:15px;
  overflow:hidden;
  box-shadow: inset 0 0 20px rgba(0,255,255,0.18);
  z-index:1;
  animation: glowPulse 3s infinite alternate;
}
@keyframes glowPulse {
  0% { box-shadow: inset 0 0 20px rgba(0,255,255,0.12); }
  50% { box-shadow: inset 0 0 35px rgba(0,255,255,0.26); }
  100% { box-shadow: inset 0 0 25px rgba(0,255,255,0.16); }
}

/* Effects layers — visual only, no interaction */
#flicker,
#distortion,
#blueBase,
#dotFlicker,
#cursor-dot {
  pointer-events: none !important;
}

#flicker { position:absolute; inset:0; background: repeating-linear-gradient(0deg, rgba(0,255,255,0.12) 0px, rgba(0,255,255,0.12) 1px, transparent 2px, transparent 3px); z-index:6; opacity:0; }
#screen::before { content:""; position:absolute; inset:0; pointer-events:none; background: repeating-linear-gradient(to bottom, rgba(0,255,255,0.03) 0px, rgba(0,255,255,0.03) 1px, transparent 2px, transparent 3px); animation: scanlines 1s linear infinite; z-index:7; }
@keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 4px; } }

#distortion { position:absolute; inset:0; background: radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(0,255,255,0.18) 0%, transparent 40%); z-index:5; }
#blueBase { position:absolute; inset:0; background-color: rgba(0,255,255,0.18); z-index:1; mix-blend-mode: screen; }
#blueBase::after { content: ""; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, rgba(0,255,255,0.04) 0px, rgba(0,255,255,0.04) 1px, transparent 2px, transparent 3px); opacity: 0.25; animation: staticNoise 0.2s steps(2) infinite; z-index:2; }
@keyframes staticNoise { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

/* ====== MAIN CONTENT ====== */
#content {
  display:flex;
  height:100%;
  position:relative;
  z-index:10; /* ensures sidebar is clickable */
}

#sidebar {
  width:200px;
  background:rgba(5,15,20,0.84);
  border-right:1px solid #033;
  display:flex;
  flex-direction:column;
  padding:15px;
  gap:8px;
}
#sidebar h2 { color:#33cfff; text-align:center; margin-bottom:6px; }

.category-btn {
  background:#0a1f26;
  border:none;
  padding:8px;
  color:#33cfff;
  text-align:left;
  border-left:4px solid #0a5266;
  cursor:pointer;
  border-radius:6px;
}
.category-btn:hover { background:#0e2a34; border-left-color:#66f0ff; }
.category-btn.active { border-left-color:#00ffff; background:#0e2a34; }

#search {
  margin-top:auto;
  padding:8px;
  background:#07131a;
  border:1px solid #113844;
  color:#a0d8ff;
  border-radius:6px;
  outline:none;
}

#main { flex:1; padding:18px; overflow-y:auto; position:relative; }
#breadcrumbs { margin-bottom:12px; font-size:14px; color:#33cfff; display:flex; gap:8px; align-items:center; }
#breadcrumbs span { cursor:pointer; text-decoration:underline; }

#entryContent h1 { font-size:22px; margin-bottom:10px; color:#66f0ff; }
#entryContent img { display:block; margin:10px auto; max-width:100%; max-height:320px; border:2px solid #33cfff; border-radius:6px; box-shadow:0 0 18px rgba(0,255,255,0.2); }
#entryContent p { font-size:15px; line-height:1.6em; white-space:pre-wrap; color:#dff6ff; }

/* Entry buttons */
.entry-row { display:flex; align-items:center; gap:8px; margin:8px 0; }
.entry-title {
  flex:1; background:#081a20; border:none; padding:8px; color:#a0d8ff;
  text-align:left; cursor:pointer;
  border-left:6px solid #0a5266; border-radius:6px; font-size:15px;
}
.entry-title.locked { border-left-color:#777; color:#777; }
.entry-title.gm-locked { border-left-color:#ffcc33; color:#ffffcc; }
.entry-title.unlocked { border-left-color:#0f0; color:#bfffdc; }

.unlock-btn { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#003; color:#66ffff; }
.unlock-btn.remove { background:#700; color:#ffc; }

/* GM indicator + lights */
#gmIndicator {
  position:absolute; top:12px; left:20px;
  background: rgba(0,0,0,0.55);
  color:#66ffff; font-size:12px; font-weight:700;
  padding:6px 10px; border-radius:6px; z-index:8;
  pointer-events:none; opacity:0; transition:opacity .16s;
}
#gmIndicator.active { opacity:1; }

.corner-lights { position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:9; pointer-events:none; }
.corner { width:12px; height:12px; border-radius:50%; box-shadow: 0 0 8px rgba(255,255,255,0.03); }
.corner.tl { position:absolute; top:12px; left:12px; background:#00aaff; box-shadow:0 0 8px #00aaff; }
.corner.tr { background:#ff4444; box-shadow:0 0 8px #ff4444; right:12px; top:12px; position:absolute; }
.corner.bl { position:absolute; bottom:12px; left:12px; background:#9a00ff; box-shadow:0 0 8px #9a00ff; }
.corner.br { position:absolute; bottom:12px; right:12px; background:#ff8c00; box-shadow:0 0 8px #ff8c00; }

#syncInfo {
  position:absolute; right:18px; top:36px; z-index:9; color:#bfeffb; font-size:12px; opacity:0.9;
  text-shadow: 0 0 4px rgba(0,0,0,0.6);
}

#cursor-dot { position:absolute; width:12px; height:12px; border-radius:50%; background: rgba(0,255,255,0.84); box-shadow:0 0 8px rgba(0,255,255,0.8), 0 0 15px rgba(0,255,255,0.35); pointer-events:none; transform:translate(-50%,-50%); z-index:7; }
#dotFlicker { position:absolute; inset:0; z-index:6; }
.dot { position:absolute; width:2px; height:2px; border-radius:50%; background: rgba(0,255,255,0.6); box-shadow:0 0 4px rgba(0,255,255,0.8); pointer-events:none; }

.controls-row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
.gm-tools { margin-left:auto; display:flex; gap:6px; }
.gm-button { background:#033; color:#8ff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; }
.gm-button:active{ transform: translateY(1px); }

.debug-panel { position:absolute; left:18px; bottom:18px; z-index:9; color:#8fefff; font-size:12px; opacity:0.9; background: rgba(0,0,0,0.25); padding:6px 8px; border-radius:6px; }

@keyframes blink { from { opacity: 1; } to { opacity: 0.4; } }

@media (max-width:960px) {
  #datapad { transform: scale(0.92); }
  #cursor-dot { display:none; }
}
</style>
</head>
<body>
<div id="datapad">
  <div id="screen">
    <div id="flicker"></div>
    <div id="distortion"></div>
    <div id="blueBase"></div>

    <div id="content">
      <div id="sidebar">
        <h2>Codex</h2>
        <button id="homeBtn" class="category-btn">Home</button>
        <button class="category-btn" data-category="planets">Planets</button>
        <button class="category-btn" data-category="characters">Characters</button>
        <button class="category-btn" data-category="technology">Technology</button>
        <button class="category-btn" data-category="items">Items</button>
        <button class="category-btn" data-category="factions">Factions</button>
        <button class="category-btn" data-category="missions">Missions</button>
        <input type="text" id="search" placeholder="Search...">
      </div>

      <div id="main">
        <div class="controls-row">
          <div id="breadcrumbs"></div>
          <div class="gm-tools" id="gmTools" style="display:none;">
            <button class="gm-button" id="exportBtn" title="Download unlocked.json">Export unlocked.json</button>
            <button class="gm-button" id="copyBtn" title="Copy unlocked.json">Copy JSON</button>
            <button class="gm-button" id="resetLocalBtn" title="Reset local unlocked state">Reset Local</button>
          </div>
        </div>

        <div id="entryContent">
          <h1>Rebel Alliance Field Codex</h1>
          <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>
        </div>
      </div>
    </div>

    <div id="dotFlicker"></div>
    <div id="cursor-dot"></div>

    <div id="gmIndicator">GM</div>
    <div class="corner-lights">
      <div class="corner tl"></div>
      <div id="statusCorner" class="corner tr"></div>
      <div class="corner bl"></div>
      <div class="corner br"></div>
    </div>
    <div id="syncInfo">Last sync: --</div>
    <div class="debug-panel" id="debugPanel" style="display:none;">debug</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const POLL_INTERVAL = 5000;
  const STALE_THRESHOLD_MS = 12000;
  const categories = ['planets','characters','technology','items','factions','missions'];

  const categoryBtns = Array.from(document.querySelectorAll('.category-btn'));
  const searchInput = document.getElementById('search');
  const homeBtn = document.getElementById('homeBtn');
  const entryContent = document.getElementById('entryContent');
  const breadcrumbs = document.getElementById('breadcrumbs');
  const gmIndicator = document.getElementById('gmIndicator');
  const statusCorner = document.getElementById('statusCorner');
  const syncInfo = document.getElementById('syncInfo');
  const cursorDot = document.getElementById('cursor-dot');
  const dotFlicker = document.getElementById('dotFlicker');
  const gmTools = document.getElementById('gmTools');
  const exportBtn = document.getElementById('exportBtn');
  const copyBtn = document.getElementById('copyBtn');
  const resetLocalBtn = document.getElementById('resetLocalBtn');
  const debugPanel = document.getElementById('debugPanel');
  const distortion = document.getElementById('distortion');

  let activeCategory = null;
  let activeEntry = null;
  let isGM = false;
  let cache = {};
  let unlockedById = {};
  let unlockedByCategory = {};
  let lastFetchedString = null;
  let lastFetchTime = 0;
  let localOverrides = {};

  function setStatus(color, blinking=false) {
    statusCorner.style.backgroundColor = color;
    statusCorner.style.boxShadow = `0 0 10px ${color}`;
    statusCorner.style.animation = blinking ? 'blink 1s infinite alternate' : '';
  }

  function setSyncInfo(text) { syncInfo.textContent = text; }

  async function fetchJson(url) {
    try {
      const res = await fetch(url + '?t=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('fetch failed ' + res.status);
      return await res.json();
    } catch (e) { console.warn('fetchJson error', url, e); return null; }
  }

  function normalizeUnlockedData(raw) {
    unlockedById = {};
    unlockedByCategory = {};
    if (!raw) return;
    if (Array.isArray(raw)) {
      raw.forEach(s => {
        if (typeof s === 'string')
          unlockedById[s.replace(/\.json$/i,'').split('/').pop()] = true;
      });
    } else if (typeof raw === 'object') {
      const valuesAreArrays = Object.values(raw).every(v => Array.isArray(v));
      if (valuesAreArrays) {
        for (const [cat,arr] of Object.entries(raw))
          unlockedByCategory[cat]={}, arr.forEach(id=>unlockedByCategory[cat][id]=true);
      } else {
        for (const k of Object.keys(raw)) unlockedById[k]=true;
      }
    }
  }

  function placeCursorAt(x,y) {
    cursorDot.style.transform = `translate(${x}px,${y}px)`;
    distortion.style.setProperty('--x', `${x}px`);
    distortion.style.setProperty('--y', `${y}px`);
  }

  document.addEventListener('mousemove', e => placeCursorAt(e.clientX,e.clientY));
  document.addEventListener('touchmove', e => { const t = e.touches[0]; placeCursorAt(t.clientX,t.clientY); });
  document.addEventListener('touchstart', e => { const t = e.touches[0]; placeCursorAt(t.clientX,t.clientY); });

  /* ===== GM MODE TOGGLE ===== */
  document.addEventListener('keydown', e => {
    if (e.key.toLowerCase() === 'g') {
      isGM = !isGM;
      gmTools.style.display = isGM ? 'flex' : 'none';
      gmIndicator.classList.toggle('active', isGM);
    }
  });

  // Example home button interaction for testing
  homeBtn.addEventListener('click', () => {
    entryContent.innerHTML = `<h1>Rebel Alliance Field Codex</h1>
    <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
    categoryBtns.forEach(btn => btn.classList.remove('active'));
    homeBtn.classList.add('active');
  });

  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeCategory = btn.dataset.category || null;
      entryContent.innerHTML = `<h1>${activeCategory ? activeCategory.toUpperCase() : "Home"}</h1>
        <p>Category loaded: ${activeCategory || "none"}</p>`;
    });
  });
});
</script>
</body>
</html>
