<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rebel Datapad Codex — Test</title>
<style>
/* Full styling (datapad aesthetic + UI) */
* { box-sizing:border-box; margin:0; padding:0; font-family:'OCR A Std','Courier New', monospace; }
body {
  background: radial-gradient(ellipse at center, #050505 0%, #000 100%);
  color:#a0d8ff;
  height:100vh; display:flex; justify-content:center; align-items:center;
  overflow:hidden;
}
#datapad {
  width:900px; height:600px;
  background: url('images/metal_texture.jpg') center/cover no-repeat;
  border:6px solid #333;
  border-radius:25px;
  position:relative;
  box-shadow: 0 0 60px rgba(0,255,255,0.05), inset 0 0 20px #000;
  overflow:hidden;
}
#datapad::before {
  content:"";
  position:absolute; inset:0;
  border-radius:25px;
  background: url('images/metal_noise.png') repeat;
  opacity:0.18;
  z-index:0;
}
#screen {
  position:absolute;
  top:40px; left:40px;
  width:820px; height:520px;
  background:radial-gradient(circle at 50% 50%, rgba(10,20,25,0.96) 0%, rgba(5,10,12,0.92) 100%);
  border-radius:15px;
  overflow:hidden;
  box-shadow: inset 0 0 20px rgba(0,255,255,0.18);
  z-index:1;
  animation: glowPulse 3s infinite alternate;
}
@keyframes glowPulse { 0% { box-shadow: inset 0 0 20px rgba(0,255,255,0.12); } 50% { box-shadow: inset 0 0 35px rgba(0,255,255,0.26); } 100% { box-shadow: inset 0 0 25px rgba(0,255,255,0.16); } }

#flicker { position:absolute; inset:0; background: repeating-linear-gradient(0deg, rgba(0,255,255,0.12) 0px, rgba(0,255,255,0.12) 1px, transparent 2px, transparent 3px); pointer-events:none; z-index:6; opacity:0; }
#screen::before { content:""; position:absolute; inset:0; pointer-events:none; background: repeating-linear-gradient(to bottom, rgba(0,255,255,0.03) 0px, rgba(0,255,255,0.03) 1px, transparent 2px, transparent 3px); animation: scanlines 1s linear infinite; z-index:7; }
@keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 4px; } }

#distortion { position:absolute; inset:0; background: radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(0,255,255,0.18) 0%, transparent 40%); pointer-events:none; z-index:5; }
#blueBase { position:absolute; inset:0; background-color: rgba(0,255,255,0.18); pointer-events:none; z-index:1; mix-blend-mode: screen; }
#blueBase::after { content: ""; position: absolute; inset: 0; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0,255,255,0.04) 0px, rgba(0,255,255,0.04) 1px, transparent 2px, transparent 3px); opacity: 0.25; animation: staticNoise 0.2s steps(2) infinite; z-index:2; }
@keyframes staticNoise { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

#content { display:flex; height:100%; position:relative; z-index:2; }
#sidebar {
  width:200px; background:rgba(5,15,20,0.84); border-right:1px solid #033;
  display:flex; flex-direction:column; padding:15px; gap:8px;
}
#sidebar h2 { color:#33cfff; text-align:center; margin-bottom:6px; }
.category-btn {
  background:#0a1f26; border:none; padding:8px; color:#33cfff; text-align:left;
  border-left:4px solid #0a5266; cursor:pointer; border-radius:6px;
}
.category-btn:hover { background:#0e2a34; border-left-color:#66f0ff; }
.category-btn.active { border-left-color:#00ffff; background:#0e2a34; }

#search { margin-top:auto; padding:8px; background:#07131a; border:1px solid #113844; color:#a0d8ff; border-radius:6px; outline:none; }

#main { flex:1; padding:18px; overflow-y:auto; position:relative; }
#breadcrumbs { margin-bottom:12px; font-size:14px; color:#33cfff; display:flex; gap:8px; align-items:center; }
#breadcrumbs span { cursor:pointer; text-decoration:underline; }

#entryContent h1 { font-size:22px; margin-bottom:10px; color:#66f0ff; }
#entryContent img { display:block; margin:10px auto; max-width:100%; max-height:320px; border:2px solid #33cfff; border-radius:6px; box-shadow:0 0 18px rgba(0,255,255,0.2); }
#entryContent p { font-size:15px; line-height:1.6em; white-space:pre-wrap; color:#dff6ff; }

.entry-row { display:flex; align-items:center; gap:8px; margin:8px 0; }
.entry-title {
  flex:1; background:#081a20; border:none; padding:8px; color:#a0d8ff; text-align:left; cursor:pointer;
  border-left:6px solid #0a5266; border-radius:6px; font-size:15px;
}
.entry-title.locked { border-left-color:#777; color:#777; }
.entry-title.gm-locked { border-left-color:#ffcc33; color:#ffffcc; }
.entry-title.unlocked { border-left-color:#0f0; color:#bfffdc; }

.unlock-btn { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#003; color:#66ffff; }
.unlock-btn.remove { background:#700; color:#ffc; }

#gmIndicator {
  position:absolute; top:12px; left:20px; background: rgba(0,0,0,0.55); color:#66ffff; font-size:12px; font-weight:700; padding:6px 10px; border-radius:6px; z-index:8; pointer-events:none; opacity:0; transition:opacity .16s;
}
#gmIndicator.active { opacity:1; }

.corner-lights { position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:9; pointer-events:none; }
.corner { width:12px; height:12px; border-radius:50%; box-shadow: 0 0 8px rgba(255,255,255,0.03); }
.corner.tl { position:absolute; top:12px; left:12px; background:#00aaff; box-shadow:0 0 8px #00aaff; }
.corner.tr { /* status light will be updated via JS */ background:#ff4444; box-shadow:0 0 8px #ff4444; right:12px; top:12px; position:absolute; }
.corner.bl { position:absolute; bottom:12px; left:12px; background:#9a00ff; box-shadow:0 0 8px #9a00ff; }
.corner.br { position:absolute; bottom:12px; right:12px; background:#ff8c00; box-shadow:0 0 8px #ff8c00; }

#syncInfo {
  position:absolute; right:18px; top:36px; z-index:9; color:#bfeffb; font-size:12px; opacity:0.9;
  text-shadow: 0 0 4px rgba(0,0,0,0.6);
}

#cursor-dot { position:absolute; width:12px; height:12px; border-radius:50%; background: rgba(0,255,255,0.84); box-shadow:0 0 8px rgba(0,255,255,0.8), 0 0 15px rgba(0,255,255,0.35); pointer-events:none; transform:translate(-50%,-50%); z-index:7; }
#dotFlicker { position:absolute; inset:0; pointer-events:none; z-index:6; }
.dot { position:absolute; width:2px; height:2px; border-radius:50%; background: rgba(0,255,255,0.6); box-shadow:0 0 4px rgba(0,255,255,0.8); pointer-events:none; }

.controls-row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
.gm-tools { margin-left:auto; display:flex; gap:6px; }

.gm-button {
  background:#033; color:#8ff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer;
}
.gm-button:active{ transform: translateY(1px); }

.debug-panel { position:absolute; left:18px; bottom:18px; z-index:9; color:#8fefff; font-size:12px; opacity:0.9; background: rgba(0,0,0,0.25); padding:6px 8px; border-radius:6px; }

@media (max-width:960px) {
  #datapad { transform: scale(0.92); }
  #cursor-dot { display:none; }
}
</style>
</head>
<body>
<div id="datapad">
  <div id="screen">
    <div id="flicker"></div>
    <div id="distortion"></div>
    <div id="blueBase"></div>

    <div id="content">
      <div id="sidebar">
        <h2>Codex</h2>
        <button id="homeBtn" class="category-btn">Home</button>
        <button class="category-btn" data-category="planets">Planets</button>
        <button class="category-btn" data-category="characters">Characters</button>
        <button class="category-btn" data-category="technology">Technology</button>
        <button class="category-btn" data-category="items">Items</button>
        <button class="category-btn" data-category="factions">Factions</button>
        <button class="category-btn" data-category="missions">Missions</button>
        <input type="text" id="search" placeholder="Search...">
      </div>

      <div id="main">
        <div class="controls-row">
          <div id="breadcrumbs"></div>
          <div class="gm-tools" id="gmTools" style="display:none;">
            <button class="gm-button" id="exportBtn" title="Download unlocked.json">Export unlocked.json</button>
            <button class="gm-button" id="copyBtn" title="Copy unlocked.json">Copy JSON</button>
            <button class="gm-button" id="resetLocalBtn" title="Reset local unlocked state">Reset Local</button>
          </div>
        </div>

        <div id="entryContent">
          <h1>Rebel Alliance Field Codex</h1>
          <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>
        </div>
      </div>
    </div>

    <div id="dotFlicker"></div>
    <div id="cursor-dot"></div>

    <div id="gmIndicator">GM</div>
    <div class="corner-lights">
      <div class="corner tl"></div>
      <div id="statusCorner" class="corner tr"></div>
      <div class="corner bl"></div>
      <div class="corner br"></div>
    </div>
    <div id="syncInfo">Last sync: --</div>
    <div class="debug-panel" id="debugPanel" style="display:none;">debug</div>
  </div>
</div>

<script>
/* Full client-side datapad script
   - Polls entries/unlocked.json every 5s (cache-busted)
   - Top-right corner (statusCorner) shows sync state:
       yellow blinking while fetching
       green when up-to-date
       red when fetch fails or stale > 12s
   - GM Mode: Ctrl+Shift+G toggles; GM gets Add/Remove local controls and Export/Copy tools
   - Exported unlocked.json is category->array (recommended for repo)
*/

document.addEventListener('DOMContentLoaded', () => {
  // --- Config
  const POLL_INTERVAL = 5000; // 5s
  const STALE_THRESHOLD_MS = 12000; // 12s considered stale -> red
  const categories = ['planets','characters','technology','items','factions','missions'];

  // --- Elements
  const categoryBtns = Array.from(document.querySelectorAll('.category-btn'));
  const searchInput = document.getElementById('search');
  const homeBtn = document.getElementById('homeBtn');
  const entryContent = document.getElementById('entryContent');
  const breadcrumbs = document.getElementById('breadcrumbs');
  const gmIndicator = document.getElementById('gmIndicator');
  const statusCorner = document.getElementById('statusCorner');
  const syncInfo = document.getElementById('syncInfo');
  const cursorDot = document.getElementById('cursor-dot');
  const dotFlicker = document.getElementById('dotFlicker');
  const gmTools = document.getElementById('gmTools');
  const exportBtn = document.getElementById('exportBtn');
  const copyBtn = document.getElementById('copyBtn');
  const resetLocalBtn = document.getElementById('resetLocalBtn');
  const debugPanel = document.getElementById('debugPanel');

  // --- State
  let activeCategory = null;
  let activeEntry = null;
  let isGM = false;
  let cache = {}; // category => entries array
  let unlockedById = {}; // id -> true (current known unlocked state from server or local)
  let unlockedByCategory = {}; // category -> Set(ids)  (for export)
  let lastFetchedString = null;
  let lastFetchTime = 0;
  let localOverrides = {}; // id -> true/false for GM toggles (local only)

  // UTIL: status light control
  function setStatus(color, blinking=false) {
    statusCorner.style.backgroundColor = color;
    statusCorner.style.boxShadow = `0 0 10px ${color}`;
    if (blinking) {
      statusCorner.style.animation = 'blink 1s infinite alternate';
    } else {
      statusCorner.style.animation = '';
    }
  }

  // UTIL: set sync info text
  function setSyncInfo(text) {
    syncInfo.textContent = text;
  }

  // UTIL: fetch JSON with cache-buster
  async function fetchJson(url) {
    try {
      const res = await fetch(url + '?t=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('fetch failed ' + res.status);
      return await res.json();
    } catch (e) {
      console.warn('fetchJson error', url, e);
      return null;
    }
  }

  // Parse unlocked.json into unlockedById and unlockedByCategory
  function normalizeUnlockedData(raw) {
    unlockedById = {};
    unlockedByCategory = {};
    if (!raw) return;
    if (Array.isArray(raw)) {
      // Array of ids or filenames -> set as IDs
      raw.forEach(s => {
        if (typeof s === 'string') {
          const id = s.replace(/\.json$/i,'').split('/').pop();
          unlockedById[id] = true;
        }
      });
    } else if (typeof raw === 'object') {
      const valuesAreArrays = Object.values(raw).every(v => Array.isArray(v));
      if (valuesAreArrays) {
        // category -> array
        for (const [cat,arr] of Object.entries(raw)) {
          unlockedByCategory[cat] = new Set();
          if (Array.isArray(arr)) {
            arr.forEach(s => {
              if (typeof s === 'string') {
                const id = s.replace(/\.json$/i,'').split('/').pop();
                unlockedById[id] = true;
                unlockedByCategory[cat].add(id);
              }
            });
          }
        }
      } else {
        // id -> true map?
        for (const [k,v] of Object.entries(raw)) {
          if (v === true) unlockedById[k] = true;
        }
      }
    }
  }

  // Build category->array object for export
  function buildExportUnlocked() {
    // Start with unlockedByCategory sets if present; merge localOverrides too
    const out = {};
    // ensure categories exist
    categories.forEach(c => out[c] = []);
    // populate from cache entries by checking unlockedById or localOverrides
    for (const cat of categories) {
      const list = cache[cat] || [];
      for (const e of list) {
        const id = e.id;
        const localVal = (localOverrides.hasOwnProperty(id) ? localOverrides[id] : undefined);
        const isUnlocked = (typeof localVal === 'boolean') ? localVal : !!unlockedById[id];
        if (isUnlocked) out[cat].push(id);
      }
    }
    // trim empty arrays to keep JSON tidy (optional)
    const cleaned = {};
    for (const [k,v] of Object.entries(out)) if (v.length) cleaned[k] = v;
    return Object.keys(cleaned).length ? cleaned : out;
  }

  function downloadJSON(obj, filename='unlocked.json') {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // --- Loading entries per category (manifest + each file)
  async function loadCategoryEntries(category) {
    if (cache[category]) return cache[category];
    const manifest = await fetchJson(`entries/${category}/manifest.json`);
    if (!Array.isArray(manifest)) {
      cache[category] = [];
      return [];
    }
    const entries = [];
    for (const filename of manifest) {
      const e = await fetchJson(`entries/${category}/${filename}`);
      if (!e) continue;
      if (!e.id) e.id = filename.replace(/\.[^/.]+$/, '');
      e.category = category;
      entries.push(e);
    }
    cache[category] = entries;
    return entries;
  }

  // --- Render breadcrumbs
  function updateBreadcrumbs() {
    breadcrumbs.innerHTML = '';
    if (!activeCategory) return;
    const catSpan = document.createElement('span');
    catSpan.textContent = activeCategory.charAt(0).toUpperCase() + activeCategory.slice(1);
    catSpan.style.cursor = 'pointer';
    catSpan.addEventListener('click', () => { activeEntry = null; renderListForActiveCategory(); });
    breadcrumbs.appendChild(catSpan);
    if (activeEntry) {
      const sep = document.createElement('span'); sep.textContent = ' > '; breadcrumbs.appendChild(sep);
      const entrySpan = document.createElement('span'); entrySpan.textContent = activeEntry.name; breadcrumbs.appendChild(entrySpan);
    }
  }

  // --- Render the list
  async function renderListForActiveCategory() {
    entryContent.innerHTML = '';
    if (!activeCategory) {
      entryContent.innerHTML = `<h1>Rebel Alliance Field Codex</h1><p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
      updateBreadcrumbs();
      return;
    }
    const entries = await loadCategoryEntries(activeCategory);
    const q = (searchInput.value || '').trim().toLowerCase();

    const list = document.createElement('div');

    for (const entry of entries) {
      const isGMOnly = Boolean(entry.gmMode);
      // local override takes precedence for GM toggles
      const localOverride = localOverrides.hasOwnProperty(entry.id) ? localOverrides[entry.id] : undefined;
      const unlocked = (typeof localOverride === 'boolean') ? localOverride : (!!unlockedById[entry.id] || !isGMOnly);

      if (!unlocked && !isGM) continue;
      if (q && !entry.name.toLowerCase().includes(q) && !(entry.description || '').toLowerCase().includes(q)) continue;

      const row = document.createElement('div'); row.className = 'entry-row';
      const titleBtn = document.createElement('button'); titleBtn.className = 'entry-title';
      titleBtn.textContent = entry.name;
      if (unlocked) titleBtn.classList.add('unlocked');
      else if (isGM) titleBtn.classList.add('gm-locked');
      else titleBtn.classList.add('locked');
      titleBtn.addEventListener('click', () => { activeEntry = entry; renderEntryDetail(entry); });
      row.appendChild(titleBtn);

      // GM controls for gm-only entries
      if (isGM && entry.gmMode) {
        const btn = document.createElement('button');
        btn.className = 'unlock-btn ' + (unlocked ? 'remove' : 'add');
        btn.textContent = unlocked ? 'Remove' : 'Add';
        btn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          localOverrides[entry.id] = !unlocked;
          // update UI quickly
          renderListForActiveCategory();
          // change status corner to yellow to show there are local unsynced changes
          setStatus('#ffff00', true);
          setSyncInfo('Local changes (export to commit)');
        });
        row.appendChild(btn);
      }

      list.appendChild(row);
    }

    if (!list.childElementCount) {
      const msg = document.createElement('p');
      msg.textContent = isGM ? 'No entries match the current filter.' : 'No entries available (locked or none).';
      entryContent.appendChild(msg);
    } else {
      entryContent.appendChild(list);
    }
    updateBreadcrumbs();
  }

  // --- Render a single entry
  function renderEntryDetail(entry) {
    entryContent.innerHTML = '';
    const title = document.createElement('h1'); title.textContent = entry.name; entryContent.appendChild(title);
    if (entry.image) {
      const img = document.createElement('img'); img.src = entry.image; img.alt = entry.name; entryContent.appendChild(img);
    }
    const p = document.createElement('p'); p.textContent = entry.description || ''; entryContent.appendChild(p);

    // GM toggle inside detail
    if (isGM && entry.gmMode) {
      const localVal = localOverrides.hasOwnProperty(entry.id) ? localOverrides[entry.id] : undefined;
      const unlocked = (typeof localVal === 'boolean') ? localVal : !!unlockedById[entry.id];
      const gmBtn = document.createElement('button');
      gmBtn.className = 'unlock-btn ' + (unlocked ? 'remove' : 'add');
      gmBtn.textContent = unlocked ? 'Remove' : 'Add';
      gmBtn.style.marginTop = '10px';
      gmBtn.addEventListener('click', () => {
        localOverrides[entry.id] = !unlocked;
        // after change go back to list
        renderListForActiveCategory();
        setStatus('#ffff00', true);
        setSyncInfo('Local changes (export to commit)');
      });
      entryContent.appendChild(gmBtn);
    }

    // Back
    const back = document.createElement('button');
    back.className = 'category-btn';
    back.textContent = 'Back';
    back.style.marginTop = '12px';
    back.addEventListener('click', () => { activeEntry = null; renderListForActiveCategory(); });
    entryContent.appendChild(back);

    updateBreadcrumbs();
  }

  // --- Fetch unlocked.json and update state & UI
  async function fetchUnlockedAndUpdate() {
    setStatus('#ffff00', true); // yellow blinking while fetching
    setSyncInfo('Checking…');
    const raw = await fetchJson('entries/unlocked.json');
    if (!raw) {
      // fetch failed
      setStatus('#ff0000', false); // red
      setSyncInfo('Fetch failed');
      console.warn('unlocked.json fetch failed or missing');
      return;
    }

    // Normalize and compute differences
    const rawString = JSON.stringify(raw);
    normalizeUnlockedData(raw);
    const now = Date.now();
    lastFetchedString = rawString;
    lastFetchTime = now;

    // show green and update UI
    setStatus('#00ff00', false); // green
    const timeStr = new Date(now).toLocaleTimeString();
    setSyncInfo('Last sync: ' + timeStr);

    // render current list if category active
    if (activeCategory && !activeEntry) await renderListForActiveCategory();

    console.log('loaded unlocked.json at', timeStr, 'content:', raw);
  }

  // Poll loop
  async function pollLoop() {
    // while fetching, set yellow blink
    await fetchUnlockedAndUpdate();
    setTimeout(pollLoop, POLL_INTERVAL);
  }

  // detect staleness (called periodically)
  function checkStale() {
    const now = Date.now();
    if (lastFetchTime === 0) {
      // no fetch yet
      setStatus('#ff0000', false);
      setSyncInfo('No sync yet');
      return;
    }
    if (now - lastFetchTime > STALE_THRESHOLD_MS) {
      // stale
      setStatus('#ff0000', false);
      setSyncInfo('Stale data (last sync ' + new Date(lastFetchTime).toLocaleTimeString() + ')');
    } else {
      // keep green
      setStatus('#00ff00', false);
      setSyncInfo('Last sync: ' + new Date(lastFetchTime).toLocaleTimeString());
    }
  }

  // --- GM tools: Export / Copy / Reset local
  exportBtn.addEventListener('click', () => {
    const obj = buildExportUnlocked();
    downloadJSON(obj, 'unlocked.json');
  });

  copyBtn.addEventListener('click', async () => {
    const obj = buildExportUnlocked();
    const s = JSON.stringify(obj, null, 2);
    try {
      await navigator.clipboard.writeText(s);
      alert('unlocked.json copied to clipboard — paste into GitHub when ready.');
    } catch (e) {
      // fallback: open in new window
      const w = window.open('', '_blank');
      w.document.body.textContent = s;
    }
  });

  resetLocalBtn.addEventListener('click', () => {
    localOverrides = {};
    renderListForActiveCategory();
    setStatus('#00ff00', false);
    setSyncInfo('Local changes reset');
  });

  // --- Wire category buttons
  categoryBtns.forEach(btn => {
    if (btn.id === 'homeBtn') return;
    btn.addEventListener('click', async () => {
      const cat = btn.dataset.category;
      if (!categories.includes(cat)) return;
      // set active state
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeCategory = cat; activeEntry = null;
      // load entries and render
      await loadCategoryEntries(cat);
      await renderListForActiveCategory();
    });
  });

  homeBtn.addEventListener('click', () => {
    categoryBtns.forEach(b => b.classList.remove('active'));
    activeCategory = null; activeEntry = null;
    searchInput.value = '';
    entryContent.innerHTML = `<h1>Rebel Alliance Field Codex</h1><p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
    updateBreadcrumbs();
  });

  searchInput.addEventListener('input', () => { if (activeCategory) renderListForActiveCategory(); });

  // GM toggle via Ctrl+Shift+G
  document.addEventListener('keydown', (ev) => {
    if (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase() === 'g') {
      isGM = !isGM;
      gmIndicator.classList.toggle('active', isGM);
      gmTools.style.display = isGM ? 'flex' : 'none';
      // show locked entries etc.
      if (activeCategory) renderListForActiveCategory();
      console.log('GM Mode', isGM ? 'ON' : 'OFF');
    }
  });

  // --- Cursor dot + mobile fallback
  const screenEl = document.getElementById('screen');
  function placeCursorAt(pageX, pageY) {
    cursorDot.style.left = pageX + 'px';
    cursorDot.style.top = pageY + 'px';
  }

  document.addEventListener('mousemove', (e) => {
    placeCursorAt(e.clientX, e.clientY);
    // update distortion coordinates relative to screenEl
    const r = screenEl.getBoundingClientRect();
    const x = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
    const y = Math.max(0, Math.min(1, (e.clientY - r.top) / r.height));
    distortion.style.setProperty('--x', (x * 100) + '%');
    distortion.style.setProperty('--y', (y * 100) + '%');
  });

  // Touch fallback on mobile: move cursor to first touch point for visual parity
  document.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    if (t) {
      placeCursorAt(t.clientX, t.clientY);
      const r = screenEl.getBoundingClientRect();
      const x = Math.max(0, Math.min(1, (t.clientX - r.left) / r.width));
      const y = Math.max(0, Math.min(1, (t.clientY - r.top) / r.height));
      distortion.style.setProperty('--x', (x * 100) + '%');
      distortion.style.setProperty('--y', (y * 100) + '%');
    }
  });

  // dot flicker
  function createRandomDot() {
    const d = document.createElement('div'); d.className = 'dot';
    const r = screenEl.getBoundingClientRect();
    d.style.left = (Math.random()*r.width + r.left) + 'px';
    d.style.top = (Math.random()*r.height + r.top) + 'px';
    dotFlicker.appendChild(d);
    setTimeout(()=> d.remove(), 120 + Math.random()*220);
  }
  setInterval(()=> { if (Math.random() < 0.28) createRandomDot(); }, 80);

  // flicker overlay
  function randomFlicker() {
    if (Math.random() < 0.4) {
      const f = document.getElementById('flicker');
      f.style.opacity = (0.06 + Math.random()*0.28).toFixed(2);
      setTimeout(()=> { f.style.opacity = 0; }, 40 + Math.random() * 160);
    }
  }
  setInterval(randomFlicker, 90);

  // debug panel toggle (press ~ to toggle)
  document.addEventListener('keydown', (e) => {
    if (e.key === '`') {
      debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
      if (debugPanel.style.display === 'block') {
        debugPanel.textContent = `lastFetch: ${lastFetchTime ? new Date(lastFetchTime).toLocaleTimeString() : 'never'}\nlocalOverrides: ${Object.keys(localOverrides).length}`;
      }
    }
  });

  // Periodic stale check
  setInterval(checkStale, 2000);

  // Start polling & initial render
  (async () => {
    // start fetch loop
    pollLoop().catch(e => console.error('pollLoop error', e));
    // initial UI
    homeBtn.click();
  })();

}); // DOMContentLoaded
</script>
</body>
</html>
