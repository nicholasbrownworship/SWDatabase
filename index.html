<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rebel Datapad Codex</title>
<style>
/* Base styling (similar to your previous datapad design) */
* { box-sizing:border-box; margin:0; padding:0; font-family:'OCR A Std','Courier New', monospace; }
body {
  background: radial-gradient(ellipse at center, #050505 0%, #000 100%);
  color:#a0d8ff;
  height:100vh; display:flex; justify-content:center; align-items:center;
  overflow:hidden;
  cursor:none;
}
#datapad {
  width:900px; height:600px;
  background: url('images/metal_texture.jpg') center/cover no-repeat;
  border:6px solid #333; border-radius:25px; position:relative;
  box-shadow: 0 0 60px rgba(0,255,255,0.05), inset 0 0 20px #000;
  overflow:hidden;
}
#screen {
  position:absolute; top:40px; left:40px;
  width:820px; height:520px;
  background:radial-gradient(circle at 50% 50%, rgba(10,20,25,0.95) 0%, rgba(5,10,12,0.9) 100%);
  border-radius:15px; overflow:hidden; box-shadow: inset 0 0 20px rgba(0,255,255,0.2);
  z-index:1; animation: glowPulse 3s infinite alternate; cursor:none;
}
#screen * { cursor:none; }
@keyframes glowPulse { 0% { box-shadow: inset 0 0 20px rgba(0,255,255,0.15); } 50% { box-shadow: inset 0 0 35px rgba(0,255,255,0.3); } 100% { box-shadow: inset 0 0 25px rgba(0,255,255,0.2); } }

#content { display:flex; height:100%; position:relative; z-index:0; }
#sidebar { width:200px; background:rgba(5,15,20,0.8); border-right:1px solid #033;
  display:flex; flex-direction:column; padding:15px; gap:6px; z-index:2; }
#sidebar h2 { color:#33cfff; text-align:center; margin-bottom:6px; }
.category-btn { background:#0a1f26; border:none; padding:8px; color:#33cfff; cursor:pointer;
  text-align:left; border-left:4px solid #0a5266; transition: all 0.14s; }
.category-btn:hover { background:#0e2a34; border-left-color:#66f0ff; }
.category-btn.active { border-left-color:#00ffff; background:#0e2a34; }
#search { margin-top:auto; padding:6px; background:#0b1c23; border:1px solid #33cfff; color:#a0d8ff; }

#main { flex:1; padding:20px; overflow-y:auto; position:relative; z-index:0; }
#breadcrumbs { margin-bottom:10px; font-size:14px; color:#33cfff; display:flex; gap:6px; align-items:center; }
#breadcrumbs span { cursor: pointer; }
#entryContent h1 { font-size:22px; margin-bottom:10px; color:#66f0ff; }
#entryContent img { display:block; margin:10px auto; max-width:100%; max-height:300px; border:2px solid #33cfff; border-radius:4px; box-shadow:0 0 15px rgba(0,255,255,0.3); }
#entryContent p { font-size:15px; line-height:1.5em; white-space:pre-wrap; }

/* Entry list button coloring indicators */
.entry-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.entry-title { flex:1; background:#0a1f26; border:none; padding:8px; color:#a0d8ff; text-align:left; cursor:pointer; border-left:6px solid #0a5266; border-radius:4px; }
.entry-title.unlocked { border-left-color:#0f0; color:#bfffdc; }
.entry-title.locked { border-left-color:#777; color:#777; }

#gmIndicator {
  position:absolute; top:10px; left:12px;
  background: rgba(0,0,0,0.45);
  color:#66ffff; font-size:12px; font-weight:700; padding:4px 8px;
  border-radius:6px; z-index:8; pointer-events:none; opacity:0; transition: opacity 0.16s ease; }
#gmIndicator.active { opacity:1; }
</style>
</head>
<body>
<div id="datapad">
  <div id="screen">
    <div id="content">
      <div id="sidebar">
        <h2>Codex</h2>
        <button id="homeBtn" class="category-btn">Home</button>
        <button class="category-btn" data-category="planets">Planets</button>
        <button class="category-btn" data-category="characters">Characters</button>
        <button class="category-btn" data-category="technology">Technology</button>
        <button class="category-btn" data-category="items">Items</button>
        <button class="category-btn" data-category="factions">Factions</button>
        <button class="category-btn" data-category="missions">Missions</button>
        <input type="text" id="search" placeholder="Search...">
      </div>
      <div id="main">
        <div id="breadcrumbs"></div>
        <div id="entryContent">
          <h1>Rebel Alliance Field Codex</h1>
          <p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>
        </div>
      </div>
    </div>
    <div id="gmIndicator">GM</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const categories = ['planets','characters','technology','items','factions','missions'];
  const entryContent = document.getElementById('entryContent');
  const breadcrumbs = document.getElementById('breadcrumbs');
  const categoryBtns = document.querySelectorAll('.category-btn');
  const searchInput = document.getElementById('search');
  const homeBtn = document.getElementById('homeBtn');
  const gmIndicator = document.getElementById('gmIndicator');

  let activeCategory = null;
  let activeEntry = null;
  let isGM = false;
  const cache = {}; // loaded entry JSON
  let unlocked = {}; // fetched unlocked entries

  const lsKey = id => `entry_unlocked__${id}`;

  async function fetchJson(path) {
    try { const r = await fetch(path+'?t='+Date.now()); if(!r.ok) return null; return await r.json(); }
    catch(e){ console.error('fetch error', path, e); return null; }
  }

  async function loadUnlocked() {
    const data = await fetchJson('entries/unlocked.json');
    if(data) unlocked = data; else unlocked = {};
  }

  async function loadCategoryEntries(category) {
    if (cache[category]) return cache[category];
    const files = await fetchJson(`entries/${category}/manifest.json`);
    if(!Array.isArray(files)){ cache[category]=[]; return []; }
    const entries = [];
    for(const file of files){
      const e = await fetchJson(`entries/${category}/${file}`);
      if(!e) continue;
      if(!e.id) e.id = file.replace(/\.[^/.]+$/,"");
      e.category = category;
      entries.push(e);
    }
    cache[category] = entries;
    return entries;
  }

  function updateBreadcrumbs() {
    breadcrumbs.innerHTML='';
    if(!activeCategory) return;
    const catSpan=document.createElement('span');
    catSpan.textContent=activeCategory.charAt(0).toUpperCase()+activeCategory.slice(1);
    catSpan.addEventListener('click', ()=>{activeEntry=null; renderList();});
    breadcrumbs.appendChild(catSpan);
    if(activeEntry){ const sep=document.createElement('span'); sep.textContent=' > '; const entrySpan=document.createElement('span'); entrySpan.textContent=activeEntry.name; breadcrumbs.appendChild(sep); breadcrumbs.appendChild(entrySpan);}
  }

  async function renderList(){
    entryContent.innerHTML='';
    if(!activeCategory){
      entryContent.innerHTML=`<h1>Rebel Alliance Field Codex</h1><p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
      updateBreadcrumbs(); return;
    }
    const entries = await loadCategoryEntries(activeCategory);
    const q = (searchInput.value||'').trim().toLowerCase();
    const list = document.createElement('div');
    for(const e of entries){
      const isUnlocked = (unlocked[activeCategory]||[]).includes(e.id) || isGM;
      if(!isUnlocked && !isGM) continue;
      if(q && !e.name.toLowerCase().includes(q) && !(e.description||'').toLowerCase().includes(q)) continue;

      const row=document.createElement('div'); row.className='entry-row';
      const btn=document.createElement('button'); btn.className='entry-title'; btn.textContent=e.name;
      btn.classList.add(isUnlocked?'unlocked':'locked');
      btn.addEventListener('click', ()=>{activeEntry=e; renderEntry(e);});
      row.appendChild(btn);
      list.appendChild(row);
    }
    if(!list.childElementCount){ const msg=document.createElement('p'); msg.textContent='No entries available.'; entryContent.appendChild(msg);}
    else entryContent.appendChild(list);
    updateBreadcrumbs();
  }

  function renderEntry(entry){
    entryContent.innerHTML='';
    const h1=document.createElement('h1'); h1.textContent=entry.name; entryContent.appendChild(h1);
    if(entry.image){ const img=document.createElement('img'); img.src=entry.image; img.alt=entry.name; entryContent.appendChild(img);}
    const p=document.createElement('p'); p.textContent=entry.description||''; entryContent.appendChild(p);
    const back=document.createElement('button'); back.className='category-btn'; back.textContent='Back'; back.style.marginTop='12px'; back.addEventListener('click', ()=>{activeEntry=null; renderList();}); entryContent.appendChild(back);
    updateBreadcrumbs();
  }

  categoryBtns.forEach(btn=>{
    if(btn.id==='homeBtn') return;
    btn.addEventListener('click', ()=>{
      const cat=btn.dataset.category; if(!categories.includes(cat)) return;
      categoryBtns.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      activeCategory=cat; activeEntry=null; renderList();
    });
  });

  homeBtn.addEventListener('click', ()=>{
    categoryBtns.forEach(b=>b.classList.remove('active'));
    activeCategory=null; activeEntry=null; searchInput.value=''; entryContent.innerHTML=`<h1>Rebel Alliance Field Codex</h1><p>Entries are not loaded until a category is selected. Click a category on the left to begin.</p>`;
    breadcrumbs.innerHTML='';
  });

  searchInput.addEventListener('input', ()=>{ if(activeCategory) renderList(); });

  document.addEventListener('keydown',(ev)=>{
    if(ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase()==='g'){
      isGM=!isGM; gmIndicator.classList.toggle('active',isGM); renderList();
      console.log('GM Mode',isGM?'ON':'OFF');
    }
  });

  async function pollUnlocked(){
    await loadUnlocked();
    if(activeCategory && !activeEntry) renderList();
    setTimeout(pollUnlocked, 5000);
  }

  pollUnlocked();
  homeBtn.click();
});
</script>
</body>
</html>
